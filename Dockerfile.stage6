# Stage 6: Text Libraries (Target: ~18 minutes)
FROM stage5-image AS stage6-text

# Continue with same environment
WORKDIR $SOURCE_DIR

# Download text library sources (3-4 minutes)
RUN echo "ğŸ”„ [6/7] Text Libraries Stage (Target: 18min)" && \
    curl -L "https://download.savannah.gnu.org/releases/freetype/freetype-2.13.2.tar.xz" -o freetype.tar.xz && \
    curl -L "https://www.freedesktop.org/software/fontconfig/release/fontconfig-2.14.2.tar.xz" -o fontconfig.tar.xz && \
    curl -L "https://github.com/fribidi/fribidi/releases/download/v1.0.13/fribidi-1.0.13.tar.xz" -o fribidi.tar.xz && \
    curl -L "https://github.com/harfbuzz/harfbuzz/releases/download/8.3.0/harfbuzz-8.3.0.tar.xz" -o harfbuzz.tar.xz && \
    curl -L "https://github.com/libass/libass/releases/download/0.17.1/libass-0.17.1.tar.xz" -o libass.tar.xz && \
    tar -xJf freetype.tar.xz && rm freetype.tar.xz && \
    tar -xJf fontconfig.tar.xz && rm fontconfig.tar.xz && \
    tar -xJf fribidi.tar.xz && rm fribidi.tar.xz && \
    tar -xJf harfbuzz.tar.xz && rm harfbuzz.tar.xz && \
    tar -xJf libass.tar.xz && rm libass.tar.xz && \
    echo "ğŸ“¦ Text sources downloaded"

# Build FreeType - ~4 minutes
RUN cd freetype-* && \
    ./configure --prefix=$FFMPEG_BUILD_ROOT --disable-shared --enable-static && \
    make -j$(nproc) && make install && \
    echo "âœ… FreeType built"

# Build FriBidi - ~3 minutes
RUN cd fribidi-* && \
    ./configure --prefix=$FFMPEG_BUILD_ROOT --disable-shared --enable-static && \
    make -j$(nproc) && make install && \
    echo "âœ… FriBidi built"

# Build HarfBuzz - ~4 minutes
RUN cd harfbuzz-* && \
    ./configure --prefix=$FFMPEG_BUILD_ROOT --disable-shared --enable-static --with-freetype && \
    make -j$(nproc) && make install && \
    echo "âœ… HarfBuzz built"

# Build FontConfig - ~4 minutes
RUN cd fontconfig-* && \
    ./configure --prefix=$FFMPEG_BUILD_ROOT --disable-shared --enable-static --with-freetype-config=$FFMPEG_BUILD_ROOT/bin/freetype-config && \
    make -j$(nproc) && make install && \
    echo "âœ… FontConfig built"

# Build libass - ~3 minutes
RUN cd libass-* && \
    ./configure --prefix=$FFMPEG_BUILD_ROOT --disable-shared --enable-static --with-fontconfig --with-harfbuzz --with-fribidi && \
    make -j$(nproc) && make install && \
    echo "âœ… libass built"

# Create stage marker
RUN echo "stage6-complete-$(date +%Y%m%d-%H%M)" > /opt/ffmpeg/stage6.marker && \
    echo "ğŸ“Š Stage 6: Text libraries completed" && \
    echo "ğŸ“ˆ Libraries: $(ls -1 $FFMPEG_BUILD_ROOT/lib/*.a 2>/dev/null | wc -l)" && \
    echo "ğŸ“ Text support: FreeType, FontConfig, ASS subtitles"

WORKDIR /opt/ffmpeg
CMD ["cat", "/opt/ffmpeg/stage6.marker"] 