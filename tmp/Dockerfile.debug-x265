FROM --platform=linux/arm64 ubuntu:22.04 AS base

# Install build tools once
RUN apt-get update && apt-get install -y \
    build-essential \
    cmake \
    git \
    curl \
    wget \
    pkg-config \
    autoconf \
    automake \
    libtool \
    nasm \
    yasm \
    python3 \
    python3-pip \
    meson \
    ninja-build \
    && rm -rf /var/lib/apt/lists/*

ENV FFMPEG_BUILD_ROOT="/opt/ffmpeg"
ENV PKG_CONFIG_PATH="$FFMPEG_BUILD_ROOT/lib/pkgconfig"
ENV PATH="$FFMPEG_BUILD_ROOT/bin:$PATH"
RUN mkdir -p "$FFMPEG_BUILD_ROOT"

# Test x264 first
FROM base AS x264
RUN git clone --depth 1 https://code.videolan.org/videolan/x264.git /tmp/x264 \
    && cd /tmp/x264 \
    && ./configure --prefix="$FFMPEG_BUILD_ROOT" --disable-shared --enable-static --enable-pic \
    && make -j$(nproc) \
    && make install \
    && echo "âœ… x264 completed"

# Test x265 with more diagnostics
FROM x264 AS x265-debug
RUN echo "ðŸ” Checking x265 build..." \
    && git clone --depth 1 https://bitbucket.org/multicoreware/x265_git.git /tmp/x265 \
    && cd /tmp/x265 \
    && echo "ðŸ“‚ x265 directory contents:" \
    && ls -la \
    && echo "ðŸ“‚ build directory contents:" \
    && ls -la build/ \
    && cd build/linux \
    && echo "ðŸ”§ Running cmake configure..." \
    && cmake -G "Unix Makefiles" -DCMAKE_INSTALL_PREFIX="$FFMPEG_BUILD_ROOT" -DENABLE_SHARED=OFF ../../source \
    && echo "ðŸ”¨ Running make with verbose output..." \
    && make -j$(nproc) VERBOSE=1 2>&1 | head -50 \
    && echo "âœ… x265 build completed" 