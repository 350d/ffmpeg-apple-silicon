FROM --platform=linux/arm64 ubuntu:22.04

# Install dependencies
RUN apt-get update && apt-get install -y \
    build-essential \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Set up environment
ENV FFMPEG_BUILD_ROOT="/opt/ffmpeg"
ENV SOURCE_DIR="/opt/ffmpeg/source"
RUN mkdir -p "/opt/ffmpeg" "/opt/ffmpeg/source"

# Download zlib
WORKDIR /opt/ffmpeg/source
RUN curl -L "https://github.com/madler/zlib/archive/refs/tags/v1.3.tar.gz" -o zlib.tar.gz && \
    tar -xzf zlib.tar.gz && rm zlib.tar.gz

# Test zlib build script function
COPY scripts/build-dependencies.sh /scripts/
RUN chmod +x /scripts/build-dependencies.sh

# Extract and test only the zlib building part
RUN cd zlib-1.3 && \
    echo "Testing zlib configure..." && \
    CC="gcc -w" ./configure --prefix=/opt/ffmpeg --64 && \
    echo "Configure successful!" && \
    make -j$(nproc) && \
    echo "Make successful!" && \
    make install && \
    echo "Install successful!" 