FROM --platform=linux/arm64 ubuntu:22.04 AS base

# Install build tools once
RUN apt-get update && apt-get install -y \
    build-essential \
    cmake \
    git \
    curl \
    wget \
    pkg-config \
    autoconf \
    automake \
    libtool \
    nasm \
    yasm \
    python3 \
    python3-pip \
    meson \
    ninja-build \
    && rm -rf /var/lib/apt/lists/*

ENV FFMPEG_BUILD_ROOT="/opt/ffmpeg"
ENV PKG_CONFIG_PATH="$FFMPEG_BUILD_ROOT/lib/pkgconfig"
ENV PATH="$FFMPEG_BUILD_ROOT/bin:$PATH"
RUN mkdir -p "$FFMPEG_BUILD_ROOT"

# Test first two optimized layers
FROM base AS core-codecs
RUN echo "ðŸš€ Building core codecs (x264, lame)..." \
    # x264 (H.264 encoder) - fastest to build
    && git clone --depth 1 https://code.videolan.org/videolan/x264.git /tmp/x264 \
    && cd /tmp/x264 \
    && ./configure --prefix="$FFMPEG_BUILD_ROOT" --disable-shared --enable-static --enable-pic \
    && make -j$(nproc) \
    && make install \
    && echo "âœ… x264 completed" \
    # libmp3lame (MP3 encoder) - small and fast
    && curl -L "https://downloads.sourceforge.net/project/lame/lame/3.100/lame-3.100.tar.gz" -o lame.tar.gz \
    && tar -xzf lame.tar.gz && rm lame.tar.gz \
    && cd lame-3.100 \
    && ./configure --prefix="$FFMPEG_BUILD_ROOT" --disable-shared --enable-static \
    && make -j$(nproc) \
    && make install \
    && echo "âœ… lame completed"

FROM core-codecs AS audio-codecs  
RUN echo "ðŸŽµ Building audio codecs (opus, vorbis)..." \
    # opus (Opus encoder)
    && git clone --depth 1 https://github.com/xiph/opus.git /tmp/opus \
    && cd /tmp/opus \
    && ./autogen.sh \
    && ./configure --prefix="$FFMPEG_BUILD_ROOT" --disable-shared --enable-static \
    && make -j$(nproc) \
    && make install \
    && echo "âœ… opus completed" \
    # libvorbis (Vorbis encoder)
    && git clone --depth 1 https://github.com/xiph/vorbis.git /tmp/vorbis \
    && cd /tmp/vorbis \
    && ./autogen.sh \
    && ./configure --prefix="$FFMPEG_BUILD_ROOT" --disable-shared --enable-static \
    && make -j$(nproc) \
    && make install \
    && echo "âœ… vorbis completed"

# Test summary
FROM audio-codecs AS final
RUN echo "ðŸŽ‰ Test summary:" \
    && ls -la "$FFMPEG_BUILD_ROOT/lib" | grep -E "(x264|lame|opus|vorbis)" \
    && echo "âœ… All core and audio codecs built successfully!" 