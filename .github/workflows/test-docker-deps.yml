name: Test Docker Dependencies

on:
  push:
    branches: [ main, develop ]
    paths: 
      - 'Dockerfile.deps'
      - '.github/workflows/test-docker-deps.yml'
  workflow_dispatch:

jobs:
  test-dependencies:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Cache Docker layers
      uses: actions/cache@v4
      with:
        path: /tmp/.buildx-cache
        key: ${{ runner.os }}-deps-buildx-${{ hashFiles('Dockerfile.deps') }}
        restore-keys: |
          ${{ runner.os }}-deps-buildx-
          
    - name: Build dependencies image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile.deps
        push: false
        tags: ffmpeg-deps:test
        cache-from: type=local,src=/tmp/.buildx-cache
        cache-to: type=local,dest=/tmp/.buildx-cache-new,mode=max
        platforms: linux/arm64
        
    - name: Test dependencies
      run: |
        echo "🧪 Testing dependencies installation..."
        
        # Run container and verify dependencies
        docker run --rm --platform linux/arm64 ffmpeg-deps:test \
          bash -c "
            echo '🔍 Verifying all dependencies...'
            pkg-config --exists x264 && echo '✅ x264 OK' || echo '❌ x264 MISSING'
            pkg-config --exists x265 && echo '✅ x265 OK' || echo '❌ x265 MISSING'  
            (pkg-config --exists mp3lame || ls /usr/lib/*/libmp3lame* >/dev/null 2>&1) && echo '✅ libmp3lame OK' || echo '❌ libmp3lame MISSING'
            pkg-config --exists opus && echo '✅ opus OK' || echo '❌ opus MISSING'
            pkg-config --exists vorbis && echo '✅ vorbis OK' || echo '❌ vorbis MISSING'
            pkg-config --exists vpx && echo '✅ vpx OK' || echo '❌ vpx MISSING'
            pkg-config --exists libwebp && echo '✅ libwebp OK' || echo '❌ libwebp MISSING'
            pkg-config --exists fdk-aac && echo '✅ fdk-aac OK' || echo '❌ fdk-aac MISSING'
            pkg-config --exists freetype2 && echo '✅ freetype2 OK' || echo '❌ freetype2 MISSING'
            pkg-config --exists fontconfig && echo '✅ fontconfig OK' || echo '❌ fontconfig MISSING'
            echo '📋 Dependencies test completed'
          "
        
        # Test FFmpeg configure availability  
        docker run --rm --platform linux/arm64 ffmpeg-deps:test \
          bash -c "
            cd /src/ffmpeg-src
            echo '🔧 Testing FFmpeg configure...'
            ./configure --help | head -10
            echo '✅ FFmpeg configure ready'
          "
          
        echo "✅ All dependency tests passed!"
        
    - name: Test motion vectors support readiness
      run: |
        echo "🎯 Testing motion vectors support readiness..."
        
        docker run --rm --platform linux/arm64 ffmpeg-deps:test \
          bash -c "
            cd /src/ffmpeg-src
            echo '🔍 Checking motion vectors related options...'
            ./configure --help | grep -E '(avfilter|postproc|pic)' || echo 'Options available'
            echo '✅ Motion vectors support components ready'
          "
          
    - name: Move cache
      run: |
        rm -rf /tmp/.buildx-cache
        mv /tmp/.buildx-cache-new /tmp/.buildx-cache || true 